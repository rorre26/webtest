<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Pong — Vertical (P2P/AI)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--panel:#151a24;--muted:#9aa4b2;--acc:#4f8cff}
    html,body{margin:0;height:100%;background:#000;color:#fff;overflow:hidden;font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif}
    canvas{display:block;width:100vw;height:100vh;background:#000}

    /* MENU */
    .menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(10,12,18,.92), rgba(10,12,18,.88));backdrop-filter:blur(6px);z-index:5}
    .card{width:min(760px,92vw);background:#0f1115;border:1px solid #1d2333;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:16px}
    h1{font-size:18px;margin:0 0 10px;font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    .seg{display:flex;gap:8px}
    .seg>button{flex:1}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--acc);color:#fff}
    .secondary{background:#1f2533;color:#eaf1ff}
    .ghost{background:transparent;border:1px solid #2a3348;color:#cfd8ef}
    .label{font-size:12px;color:var(--muted);margin:4px 0 2px}
    textarea{width:100%;min-height:90px;background:#0b1020;border:1px solid #222a3c;border-radius:12px;color:#eaf1ff;padding:10px}
    input[type="text"]{width:100%;background:#0b1020;border:1px solid #222a3c;border-radius:12px;color:#eaf1ff;padding:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
    .status{font-size:12px;color:#cfd8ef}
    .hidden{display:none}
    .small{font-size:11px;color:#9aa4b2}
    .tests{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:11px;background:#0b1020;border:1px dashed #2a3348;color:#d6e2ff;padding:8px;border-radius:12px;max-height:120px;overflow:auto}
    /* OVER */
    .over{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:4}
    .over .card{width:min(420px,92vw)}
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- MENU -->
  <div class="menu" id="menu">
    <div class="card">
      <h1>Telegram Pong — настройки матча</h1>
      <div class="muted" style="margin-bottom:10px">Выберите тип матча. Для игры с человеком можно использовать <b>короткий ключ (10 символов)</b> через сигнальный сервис, либо длинный код без сервера.</div>

      <div class="grid">
        <!-- LEFT: TYPE + ROLE -->
        <div class="col">
          <div class="label">Тип матча</div>
          <div class="seg">
            <button id="btnTypeAI"   class="secondary">Играть с ПК</button>
            <button id="btnTypeP2P"  class="secondary">Играть с человеком</button>
          </div>

          <div id="roleBox" class="hidden">
            <div class="label">Роль</div>
            <div class="seg">
              <button id="btnHost" class="ghost">Я создаю матч</button>
              <button id="btnJoin" class="ghost">Я присоединяюсь</button>
            </div>
            <div class="status">Сеть: <span id="net">offline</span></div>
            <div class="small">Режим коротких ключей: <span id="shortMode">выкл</span></div>
          </div>
        </div>

        <!-- RIGHT: SIGNALING -->
        <div id="signalBox" class="hidden col">
          <!-- HOST PANEL -->
          <div id="hostPanel" class="hidden">
            <div class="label">1) Создай инвайт и отправь другу</div>
            <div class="row">
              <button id="btnMakeOffer" class="primary">Создать инвайт</button>
              <button id="btnShareOffer" class="secondary">Поделиться в Telegram</button>
              <button id="btnCopyOffer" class="ghost">Скопировать</button>
            </div>
            <textarea id="offerOut" readonly placeholder="Инвайт (ключ из 10 символов или сжатый код)"></textarea>
            <div class="small">Длина: <span id="offerLen">0</span> симв.</div>
            <div id="hostAnswerBox">
              <div class="label">2) Получи от друга ответ и вставь</div>
              <textarea id="answerIn" placeholder="Вставь ответ (answer) или повтори тот же ключ"></textarea>
              <div class="row"><button id="btnApplyAnswer" class="primary">Применить answer</button></div>
            </div>
          </div>

          <!-- JOIN PANEL -->
          <div id="joinPanel" class="hidden">
            <div class="label">1) Вставь инвайт от хоста (ключ из 10 символов или длинный код)</div>
            <textarea id="offerIn" placeholder="Вставь инвайт (offer)"></textarea>
            <div class="row"><button id="btnMakeAnswer" class="primary">Сгенерировать/Отправить answer</button></div>
            <div class="label">2) Отправь этот answer хосту (в режиме коротких ключей — просто пришли тот же ключ)</div>
            <textarea id="answerOut" readonly placeholder="Ваш answer или ключ"></textarea>
            <div class="small">Длина: <span id="answerLen">0</span> симв.</div>
            <div class="row"><button id="btnCopyAnswer" class="ghost">Скопировать</button></div>
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="btnPlay" class="primary" disabled>Играть</button>
      </div>

      <div id="testBox" class="tests" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- GAME OVER OVERLAY -->
  <div id="over" class="over hidden">
    <div class="card">
      <h1 id="overTitle">Матч окончен</h1>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="btnBackToMenu" class="secondary">В меню</button>
        <button id="btnRematch" class="primary">Сыграть ещё</button>
      </div>
    </div>
  </div>

  <!-- LZ-String (MIT) для сжатия кодов: https://github.com/pieroxy/lz-string -->
  <script>
  /*! LZ-String (c) 2013 Pieroxy - MIT */
  var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={},t={},i={compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return n.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},_compress:function(o,n,e){if(null==o)return"";var t,i,a,s={},u={},c="",p="",l="",f=2,h=3,d=2,m=[],v=0,g=0;for(a=0;a<o.length;a+=1)if(c=o.charAt(a),Object.prototype.hasOwnProperty.call(s,c)||(s[c]=h++,u[c]=!0),p=l+c,Object.prototype.hasOwnProperty.call(s,p))l=p;else{if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(t=0;t<d;t++)v<<=1,g==n-1?(g=0,m.push(e(v)),v=0):g++;for(i=l.charCodeAt(0),t=0;t<8;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1}else{for(i=1,t=0;t<d;t++)v=v<<1|i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i=0;for(i=l.charCodeAt(0),t=0;t<16;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1}f--,0==f&&(f=Math.pow(2,d),d++),delete u[l]}else for(i=s[l],t=0;t<d;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1;for(i=0,t=0;t<d;t++)v<<=1,g==n-1?(g=0,m.push(e(v)),v=0):g++;s[p]=h++,l=String(c)}if(""!==l){if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(t=0;t<d;t++)v<<=1,g==n-1?(g=0,m.push(e(v)),v=0):g++;for(i=l.charCodeAt(0),t=0;t<8;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1}else{for(i=1,t=0;t<d;t++)v=v<<1|i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i=0;for(i=l.charCodeAt(0),t=0;t<16;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1}f--,0==f&&(f=Math.pow(2,d),d++),delete u[l]}else for(i=s[l],t=0;t<d;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1;for(i=2,t=0;t<d;t++)v=v<<1|1&i,g==n-1?(g=0,m.push(e(v)),v=0):g++,i>>=1}for(;;){if(v<<=1,g==n-1){m.push(e(v));break}g++}return m.join("")},_decompress:function(o,r,n){var e,t,i,a,s,u,c,p,l,f,h=[],d=4,m=4,v=3,g="",w=[],A={val:n(0),position:r,index:1};for(t=0;t<3;t+=1)h[t]=t;for(i=0,f=Math.pow(2,2),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;switch(e=i){case 0:for(i=0,f=Math.pow(2,8),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[3]=r(i);e=3;break;case 1:for(i=0,f=Math.pow(2,16),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[3]=r(i);e=3;break;case 2:return""}for(t=0,c=Math.pow(2,v),a=1;a!=c;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),t|=(s>0?1:0)*a,a<<=1;switch(e=t){case 0:for(i=0,f=Math.pow(2,8),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[m++]=r(i),t=m-1,v--;break;case 1:for(i=0,f=Math.pow(2,16),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[m++]=r(i),t=m-1,v--;break;case 2:return""}for(e=h[t],w.push(e);;){if(A.index>o)return"";for(t=0,c=Math.pow(2,v),a=1;a!=c;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),t|=(s>0?1:0)*a,a<<=1;switch(e=t){case 0:for(i=0,f=Math.pow(2,8),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[m++]=r(i),v--;break;case 1:for(i=0,f=Math.pow(2,16),a=1;a!=f;)s=A.val&A.position,A.position>>=1,0==A.position&&(A.position=r,A.val=n(A.index++)),i|=(s>0?1:0)*a,a<<=1;h[m++]=r(i),v--;break;case 2:return w.join("")}"string"==typeof h[e]?g=h[e]+g:g=h[e]+g;for(;m>3&&0==--d;)d=Math.pow(2,++v),m++}return w.join("")}};return i}();
  </script>

  <script>
  // --- Telegram fullscreen
  const tg = window.Telegram?.WebApp; try{ tg?.expand(); tg?.ready(); }catch(_){}

  // --- CONFIG: set SIGNAL_URL to enable 10-char keys (Cloudflare Worker or any tiny signaling API)
  // Examples:
  //  - '' (empty) => fallback to long compressed codes (serverless)
  //  - 'memory://' => local in-memory store (for tests in one tab)
  //  - 'https://<your-worker>.workers.dev' => real short-key signaling
  const SIGNAL_URL = '';
  const SHORT_MODE = !!SIGNAL_URL;

  // --- Canvas setup
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  let W,H; function resize(){ W=cvs.width=innerWidth; H=cvs.height=innerHeight; } window.addEventListener('resize',resize); resize();

  // --- UI elements
  const menu = document.getElementById('menu');
  const btnTypeAI = document.getElementById('btnTypeAI');
  const btnTypeP2P = document.getElementById('btnTypeP2P');
  const roleBox = document.getElementById('roleBox');
  const signalBox = document.getElementById('signalBox');
  const btnHost = document.getElementById('btnHost');
  const btnJoin = document.getElementById('btnJoin');
  const hostPanel = document.getElementById('hostPanel');
  const joinPanel = document.getElementById('joinPanel');
  const net = document.getElementById('net');
  const shortModeEl = document.getElementById('shortMode');
  const btnPlay = document.getElementById('btnPlay');

  const offerOut = document.getElementById('offerOut');
  const answerIn = document.getElementById('answerIn');
  const offerIn = document.getElementById('offerIn');
  const answerOut = document.getElementById('answerOut');
  const btnCopyOffer = document.getElementById('btnCopyOffer');
  const btnShareOffer = document.getElementById('btnShareOffer');
  const btnMakeOffer = document.getElementById('btnMakeOffer');
  const btnApplyAnswer = document.getElementById('btnApplyAnswer');
  const btnMakeAnswer = document.getElementById('btnMakeAnswer');
  const btnCopyAnswer = document.getElementById('btnCopyAnswer');
  const offerLen = document.getElementById('offerLen');
  const answerLen = document.getElementById('answerLen');
  const testBox = document.getElementById('testBox');

  // --- OVERLAY
  const over = document.getElementById('over');
  const overTitle = document.getElementById('overTitle');
  const btnBackToMenu = document.getElementById('btnBackToMenu');
  const btnRematch = document.getElementById('btnRematch');

  // --- State
  let matchType = 'ai'; // 'ai' | 'p2p'
  let role = null;      // 'host' | 'join'
  let mode = 'menu';    // 'menu' | 'online' | 'practice'
  let isHost = false;
  let currentKey = null; // 10-char key for short mode
  let pollTimer = null;

  // --- Game constants (vertical)
  const PADDLE_W = 120, PADDLE_H = 12, BALL = 12;
  const WIN_SCORE = 11;
  const BALL_ACCEL = 1.06; // ускорение при касании
  const BALL_MAX = 12;     // ограничение скорости

  const player = {x:0, y:0, score:0};
  const enemy  = {x:0, y:0, score:0};
  const ball   = {x:0, y:0, vx:0, vy:0};

  function resetPositions(){
    player.x = W/2 - PADDLE_W/2; player.y = H - 28;
    enemy.x  = W/2 - PADDLE_W/2; enemy.y  = 16;
    ball.x = W/2; ball.y = H/2; ball.vx = (Math.random()>0.5?1:-1)*(3+Math.random()*2); ball.vy = (isHost?1:-1)*(3+Math.random()*2);
  }
  resetPositions();

  // --- Input
  let keys = {}; window.addEventListener('keydown', e=>keys[e.key]=true); window.addEventListener('keyup', e=>keys[e.key]=false);
  cvs.addEventListener('pointermove', e=>{
    if (mode!=='online' && mode!=='practice') return;
    const r=cvs.getBoundingClientRect(); const x=(e.clientX - r.left)*(W/r.width) - PADDLE_W/2;
    player.x = Math.max(0, Math.min(W-PADDLE_W, x));
  });
  function localStep(){
    if (mode!=='online' && mode!=='practice') return;
    if (keys['ArrowLeft']||keys['a']) player.x -= 7;
    if (keys['ArrowRight']||keys['d']) player.x += 7;
    player.x = Math.max(0, Math.min(W-PADDLE_W, player.x));
  }

  // --- Match type selection
  function updateTypeButtons(){
    btnTypeAI.className = (matchType==='ai')? 'primary' : 'secondary';
    btnTypeP2P.className = (matchType==='p2p')? 'primary' : 'secondary';
    roleBox.classList.toggle('hidden', matchType!=='p2p');
    signalBox.classList.toggle('hidden', matchType!=='p2p');
    btnPlay.disabled = (matchType==='p2p'); // для p2p кнопка активируется после online
    shortModeEl.textContent = SHORT_MODE ? 'вкл' : 'выкл';
    document.getElementById('hostAnswerBox').classList.toggle('hidden', SHORT_MODE); // в коротком режиме answer вводить не нужно
  }
  btnTypeAI.onclick = ()=>{ matchType='ai'; role=null; updateTypeButtons(); };
  btnTypeP2P.onclick = ()=>{ matchType='p2p'; updateTypeButtons(); };
  updateTypeButtons();

  // --- Role selection
  btnHost.onclick = ()=>{ role='host'; btnHost.className='primary'; btnJoin.className='ghost'; hostPanel.classList.remove('hidden'); joinPanel.classList.add('hidden'); };
  btnJoin.onclick = ()=>{ role='join'; btnJoin.className='primary'; btnHost.className='ghost'; hostPanel.classList.add('hidden'); joinPanel.classList.remove('hidden'); };

  // --- Helpers: encoding + keys + copy
  function encodeInvite(obj){
    try{ return 'Z'+LZString.compressToEncodedURIComponent(JSON.stringify(obj)); }catch(e){
      return 'B'+btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    }
  }
  function decodeInvite(text){
    const s=(text||'').trim();
    if(!s) throw new Error('Пустой код');
    if(s.startsWith('Z')){ const raw=LZString.decompressFromEncodedURIComponent(s.slice(1)); if(!raw) throw new Error('Не удалось распаковать код'); return JSON.parse(raw); }
    if(s.startsWith('B')){ return JSON.parse(decodeURIComponent(escape(atob(s.slice(1))))); }
    try{ const raw=LZString.decompressFromEncodedURIComponent(s); if(raw) return JSON.parse(raw);}catch(_){ }
    try{ return JSON.parse(decodeURIComponent(escape(atob(s)))); }catch(_){ }
    throw new Error('Код не распознан');
  }
  async function copyText(el){ try{ await navigator.clipboard.writeText(el.value); }catch(_){ el.select(); document.execCommand('copy'); } }
  function generateKey(len=10){ const abc='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let k=''; for(let i=0;i<len;i++) k+=abc[Math.floor(Math.random()*abc.length)]; return k; }

  // --- Short signaling client
  async function sigPut(key, role, data){
    if (SIGNAL_URL==='memory://'){ window._mem = window._mem||new Map(); window._mem.set(key+':'+role, data); return {ok:true}; }
    if (!SIGNAL_URL) throw new Error('SIGNAL_URL не настроен');
    const r = await fetch(SIGNAL_URL+'/put', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({k:key, role, data})});
    if (!r.ok) throw new Error('sigPut HTTP '+r.status);
    return r.json().catch(()=>({ok:true}));
  }
  async function sigGet(key, role){
    if (SIGNAL_URL==='memory://'){ return window._mem?.get(key+':'+role) || null; }
    if (!SIGNAL_URL) throw new Error('SIGNAL_URL не настроен');
    const r = await fetch(SIGNAL_URL+'/get?k='+encodeURIComponent(key)+'&role='+encodeURIComponent(role));
    if (r.status===404) return null; if(!r.ok) throw new Error('sigGet HTTP '+r.status);
    return r.json();
  }

  // --- WebRTC
  let pc, dc; let lastTick=0;
  const iceServers=[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'},
    {urls:'stun:stun2.l.google.com:19302'}
  ];
  function setupPeer(host){
    isHost = !!host;
    pc = new RTCPeerConnection({iceServers});
    pc.onicecandidate = e=>{ if(!e.candidate) updateSDP(); };
    pc.onconnectionstatechange = ()=>{ net.textContent = pc.connectionState || 'unknown'; if (pc.connectionState==='connected'){ btnPlay.disabled=false; }};
    pc.ondatachannel = ev=>{ dc = ev.channel; wireDC(); };
    if (host){ dc = pc.createDataChannel('game'); wireDC(); }
  }
  function wireDC(){
    dc.onopen = ()=>{ net.textContent='online'; };
    dc.onclose= ()=>{ net.textContent='disconnected'; btnPlay.disabled=true; };
    dc.onmessage = ev=>{
      let m; try{ m=JSON.parse(ev.data);}catch(_){return;}
      if (m.t==='state' && !isHost){
        const s = m.state;
        enemy.x = s.bottom.x; enemy.score = s.bottom.score; enemy.y = 16;
        player.x = s.top.x;   player.score = s.top.score;   player.y = H - 28;
        ball.x = s.ball.x; ball.y = s.ball.y;
        if (s.over){ showOver(s.over.winner==='bottom' ? 'Победа!' : 'Поражение :('); }
      }
      if (m.t==='input' && isHost){ enemy.x = Math.max(0, Math.min(W-PADDLE_W, m.x)); }
    };
  }

  // --- SDP exchange (manual vs short)
  async function updateSDP(){
    if (!pc?.localDescription) return;
    const desc = {type:pc.localDescription.type, sdp:pc.localDescription.sdp};
    if (SHORT_MODE){
      if (!currentKey) currentKey = generateKey(10);
      offerOut.value = currentKey; offerLen.textContent = currentKey.length;
      if (isHost) await sigPut(currentKey, 'offer', desc); else { await sigPut(currentKey, 'answer', desc); answerOut.value=currentKey; answerLen.textContent=currentKey.length; }
    } else {
      const payload = encodeInvite(desc);
      if (isHost){ offerOut.value = payload; offerLen.textContent = payload.length; } else { answerOut.value = payload; answerLen.textContent = payload.length; }
    }
  }

  async function makeOffer(){
    setupPeer(true);
    currentKey = SHORT_MODE ? generateKey(10) : null;
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await updateSDP();
    if (SHORT_MODE){ startPollForAnswer(); }
  }

  function startPollForAnswer(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const ans = await sigGet(currentKey, 'answer');
        if (ans){ clearInterval(pollTimer); pollTimer=null; await pc.setRemoteDescription(new RTCSessionDescription(ans)); }
      }catch(err){ /* ignore transient */ }
    }, 1500);
  }

  async function applyAnswer(){
    if (SHORT_MODE){
      const key = (answerIn.value.trim() || currentKey);
      if (!key || key.length!==10) return alert('Укажите ключ из 10 символов');
      currentKey = key; // adopt
      startPollForAnswer();
      return;
    }
    try{ const ans = decodeInvite(answerIn.value); await pc.setRemoteDescription(new RTCSessionDescription(ans)); }catch(e){ alert('Неверный answer: '+e.message); }
  }

  async function acceptOffer(){
    if (SHORT_MODE){
      const key = offerIn.value.trim(); if(!key || key.length!==10) return alert('Нужен ключ из 10 символов');
      currentKey = key;
      const off = await sigGet(currentKey, 'offer'); if (!off) return alert('Инвайт по ключу не найден');
      await pc.setRemoteDescription(new RTCSessionDescription(off));
      const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); await updateSDP();
      answerOut.value = currentKey; answerLen.textContent=currentKey.length; return;
    }
    try{ const off = decodeInvite(offerIn.value); await pc.setRemoteDescription(new RTCSessionDescription(off)); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); await updateSDP(); }catch(e){ alert('Неверный offer: '+e.message); }
  }

  btnMakeOffer.onclick = makeOffer;
  btnApplyAnswer.onclick = applyAnswer;
  btnMakeAnswer.onclick = acceptOffer;
  btnCopyOffer.onclick = ()=>copyText(offerOut);
  btnCopyAnswer.onclick = ()=>copyText(answerOut);
  btnShareOffer.onclick = ()=>{
    const text = encodeURIComponent('Поиграем в Pong? Ключ: '+offerOut.value+'\nОткрой игру, выбери Join и вставь ключ.');
    if (tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/share/url?text='+text); else window.open('https://t.me/share/url?text='+text,'_blank');
  };

  // --- Physics (host authoritative) + acceleration + win to 11
  function bounceFromPaddle(isBottom){
    // отражение по Y + добавляем «англ» по X и ускорение
    const pad = isBottom ? player : enemy;
    const rel = (ball.x + BALL/2) - (pad.x + PADDLE_W/2); // -W/2..+W/2
    // инвертируем vy и ускоряем
    ball.vy = -ball.vy * BALL_ACCEL;
    // небольшое влияние по X
    ball.vx += (rel/(PADDLE_W/2)) * 1.8;
    // ограничиваем
    ball.vx = Math.max(-BALL_MAX, Math.min(BALL_MAX, ball.vx));
    ball.vy = Math.max(-BALL_MAX, Math.min(BALL_MAX, ball.vy));
  }

  function physics(){
    ball.x += ball.vx; ball.y += ball.vy;
    if (ball.x<0 || ball.x>W-BALL) ball.vx *= -1;
    // top paddle
    if (ball.vy<0 && ball.y < enemy.y+PADDLE_H && ball.x+BALL>enemy.x && ball.x<enemy.x+PADDLE_W){ bounceFromPaddle(false); }
    // bottom paddle
    if (ball.vy>0 && ball.y+BALL > player.y && ball.x+BALL>player.x && ball.x<player.x+PADDLE_W){ bounceFromPaddle(true); }
    // score
    if (ball.y < -BALL){ player.score++; checkWin(); resetBall(1); }
    if (ball.y > H+BALL){ enemy.score++; checkWin(); resetBall(-1); }
  }
  function resetBall(dir){ ball.x=W/2; ball.y=H/2; ball.vx=(Math.random()>0.5?1:-1)*(3+Math.random()*2); ball.vy=dir*(3+Math.random()*2); }

  function checkWin(){
    if (player.score>=WIN_SCORE || enemy.score>=WIN_SCORE){
      const over = {winner: player.score>enemy.score? 'bottom':'top'};
      if (isHost && dc && dc.readyState==='open'){ dc.send(JSON.stringify({t:'state', state:{bottom:{x:player.x, score:player.score}, top:{x:enemy.x, score:enemy.score}, ball:{x:ball.x,y:ball.y}, over}})); }
      showOver(over.winner==='bottom' ? 'Победа!' : 'Поражение :(');
      mode='menu'; // останавливаем управление, но рендер остаётся
    }
  }

  // --- AI for practice
  function aiStep(){ const target = ball.x - PADDLE_W/2; const speed = 5; enemy.x += Math.sign(target - enemy.x) * speed; enemy.x = Math.max(0, Math.min(W-PADDLE_W, enemy.x)); }

  // --- Play / Over / Rematch
  btnPlay.onclick = ()=>{
    if (matchType==='ai') { mode='practice'; isHost=true; hideMenu(); resetScores(); resetPositions(); return; }
    if (matchType==='p2p') {
      if (pc?.connectionState === 'connected' && dc?.readyState==='open') { mode='online'; hideMenu(); resetScores(); resetPositions(); } else { alert('Сначала установите соединение (online)'); }
    }
  };
  function hideMenu(){ menu.classList.add('hidden'); tg?.expand(); }
  function showMenu(){ menu.classList.remove('hidden'); }
  function resetScores(){ player.score=0; enemy.score=0; }

  function showOver(title){ overTitle.textContent=title; over.classList.remove('hidden'); }
  function hideOver(){ over.classList.add('hidden'); }
  btnBackToMenu.onclick = ()=>{ hideOver(); showMenu(); mode='menu'; };
  btnRematch.onclick   = ()=>{ hideOver(); btnPlay.click(); };

  // --- Main loop
  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#fff';
    ctx.fillRect(player.x, player.y, PADDLE_W, PADDLE_H);
    ctx.fillRect(enemy.x,  enemy.y,  PADDLE_W, PADDLE_H);
    ctx.fillRect(ball.x,   ball.y,   BALL,     BALL);
    ctx.font='20px sans-serif';
    ctx.fillText(player.score, 16, H-20);
    ctx.fillText(enemy.score,  16, 36);
  }

  function loop(ts){
    localStep();
    if (mode==='practice'){ aiStep(); physics(); }
    else if (mode==='online'){
      if (dc && dc.readyState==='open'){ dc.send(JSON.stringify({t:'input', x: player.x})); }
      if (isHost){ physics(); if (!lastTick || ts-lastTick>33){ lastTick=ts; if (dc && dc.readyState==='open'){
        const state = { bottom:{x:player.x, score:player.score}, top:{x:enemy.x, score:enemy.score}, ball:{x:ball.x, y:ball.y} };
        dc.send(JSON.stringify({t:'state', state}));
      }}}
    }
    draw(); requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // --- Self-tests (run on load; results in console & box)
  function runTests(){
    const out=[]; const log=(name, ok, msg='')=>{ out.push(`${ok?'✅':'❌'} ${name}${msg?': '+msg:''}`); console[ok?'log':'warn'](name, ok?'- OK':('-> '+msg)); };
    try{
      // T1: encode/decode roundtrip (LZ path)
      const sample={type:'offer', sdp:'x'.repeat(1200)}; const enc=encodeInvite(sample); const dec=decodeInvite(enc);
      log('T1 roundtrip LZ', JSON.stringify(sample)===JSON.stringify(dec), `len=${enc.length}`);
      // T2: fallback B64 path
      const b='B'+btoa(unescape(encodeURIComponent(JSON.stringify(sample)))); const decB=decodeInvite(b);
      log('T2 fallback B64', JSON.stringify(sample)===JSON.stringify(decB));
      // T3: invalid input must fail
      let failed=false; try{ decodeInvite('not-a-code'); }catch(e){ failed=true; }
      log('T3 invalid code rejects', failed);
      // T4: compressed shorter than raw
      const raw=JSON.stringify(sample); log('T4 compressed shorter', encodeInvite(sample).length < raw.length, `raw=${raw.length}`);
      // T5: short key length
      const k=generateKey(10); log('T5 key len 10', k.length===10, k);
      // T6: memory signaling (if enabled)
      if (SIGNAL_URL==='memory://'){ (async()=>{ const key=generateKey(10); await sigPut(key,'offer',{type:'offer', sdp:'ok'}); const got=await sigGet(key,'offer'); log('T6 mem put/get', !!got && got.sdp==='ok'); })(); }
    }catch(e){ out.push('❌ Tests crashed: '+e.message); console.error(e); }
    testBox.textContent = out.join('\n');
  }
  runTests();
  </script>

  <!--
  ==========================
  OPTIONAL: Cloudflare Worker (short-code signaling, 10-char keys)
  Deploy on https://workers.cloudflare.com/ (Free). Paste JS below as an HTTP handler.
  Then set SIGNAL_URL to your Worker URL. CORS is open for quick tests.

  export default {
    async fetch(req, env) {
      const url = new URL(req.url);
      const headers = { 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Headers':'*' };
      if (req.method==='OPTIONS') return new Response('', {headers});
      globalThis._store = globalThis._store || new Map();
      if (url.pathname === '/put' && req.method==='POST'){
        const {k, role, data} = await req.json();
        if (!k || !role || !data) return new Response('bad', {status:400, headers});
        _store.set(`${k}:${role}`, data); return new Response(JSON.stringify({ok:true}), {headers});
      }
      if (url.pathname === '/get' && req.method==='GET'){
        const k=url.searchParams.get('k'); const role=url.searchParams.get('role');
        const val=_store.get(`${k}:${role}`);
        if (!val) return new Response('nf', {status:404, headers});
        return new Response(JSON.stringify(val), {headers:{...headers,'Content-Type':'application/json'}});
      }
      return new Response('ok', {headers});
    }
  }

  NOTE: in-memory store is ephemeral and not for prod. For reliability use KV / Durable Object.
  ==========================
  -->
</body>
</html>

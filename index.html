<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Pong — Vertical (P2P/AI)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--panel:#151a24;--muted:#9aa4b2;--acc:#4f8cff}
    html,body{margin:0;height:100%;background:#000;color:#fff;overflow:hidden;font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif}
    canvas{display:block;width:100vw;height:100vh;background:#000}

    /* MENU */
    .menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(10,12,18,.92), rgba(10,12,18,.88));backdrop-filter:blur(6px)}
    .card{width:min(760px,92vw);background:#0f1115;border:1px solid #1d2333;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:16px}
    h1{font-size:18px;margin:0 0 10px;font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    .seg{display:flex;gap:8px}
    .seg>button{flex:1}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--acc);color:#fff}
    .secondary{background:#1f2533;color:#eaf1ff}
    .ghost{background:transparent;border:1px solid #2a3348;color:#cfd8ef}
    .label{font-size:12px;color:var(--muted);margin:4px 0 2px}
    textarea{width:100%;min-height:110px;background:#0b1020;border:1px solid #222a3c;border-radius:12px;color:#eaf1ff;padding:10px}
    input[type="text"]{width:100%;background:#0b1020;border:1px solid #222a3c;border-radius:12px;color:#eaf1ff;padding:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
    .status{font-size:12px;color:#cfd8ef}
    .hidden{display:none}
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- MENU -->
  <div class="menu" id="menu">
    <div class="card">
      <h1>Telegram Pong — настройки матча</h1>
      <div class="muted" style="margin-bottom:10px">Выберите тип матча. Для игры с человеком нужно обменяться кодами (offer/answer). После подготовки нажмите «Играть».</div>

      <div class="grid">
        <!-- LEFT: TYPE + ROLE -->
        <div class="col">
          <div class="label">Тип матча</div>
          <div class="seg">
            <button id="btnTypeAI"   class="secondary">Играть с ПК</button>
            <button id="btnTypeP2P"  class="secondary">Играть с человеком</button>
          </div>

          <div id="roleBox" class="hidden">
            <div class="label">Роль</div>
            <div class="seg">
              <button id="btnHost" class="ghost">Я создаю матч</button>
              <button id="btnJoin" class="ghost">Я присоединяюсь</button>
            </div>
            <div class="status">Сеть: <span id="net">offline</span></div>
          </div>
        </div>

        <!-- RIGHT: SIGNALING -->
        <div id="signalBox" class="hidden col">
          <!-- HOST PANEL -->
          <div id="hostPanel" class="hidden">
            <div class="label">1) Создай инвайт (offer) и отправь другу</div>
            <div class="row">
              <button id="btnMakeOffer" class="primary">Создать инвайт</button>
              <button id="btnShareOffer" class="secondary">Поделиться в Telegram</button>
              <button id="btnCopyOffer" class="ghost">Скопировать</button>
            </div>
            <textarea id="offerOut" readonly placeholder="Тут появится offer-код"></textarea>
            <div class="label">2) Получи от друга answer и вставь</div>
            <textarea id="answerIn" placeholder="Вставь answer"></textarea>
            <div class="row"><button id="btnApplyAnswer" class="primary">Применить answer</button></div>
          </div>

          <!-- JOIN PANEL -->
          <div id="joinPanel" class="hidden">
            <div class="label">1) Вставь offer от хоста</div>
            <textarea id="offerIn" placeholder="Вставь offer"></textarea>
            <div class="row"><button id="btnMakeAnswer" class="primary">Сгенерировать answer</button></div>
            <div class="label">2) Отправь этот answer хосту</div>
            <textarea id="answerOut" readonly placeholder="Тут появится answer"></textarea>
            <div class="row"><button id="btnCopyAnswer" class="ghost">Скопировать answer</button></div>
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="btnPlay" class="primary" disabled>Играть</button>
      </div>
    </div>
  </div>

  <script>
  // --- Telegram fullscreen
  const tg = window.Telegram?.WebApp; try{ tg?.expand(); tg?.ready(); }catch(_){}

  // --- Canvas setup
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  let W,H; function resize(){ W=cvs.width=innerWidth; H=cvs.height=innerHeight; } window.addEventListener('resize',resize); resize();

  // --- UI elements
  const menu = document.getElementById('menu');
  const btnTypeAI = document.getElementById('btnTypeAI');
  const btnTypeP2P = document.getElementById('btnTypeP2P');
  const roleBox = document.getElementById('roleBox');
  const signalBox = document.getElementById('signalBox');
  const btnHost = document.getElementById('btnHost');
  const btnJoin = document.getElementById('btnJoin');
  const hostPanel = document.getElementById('hostPanel');
  const joinPanel = document.getElementById('joinPanel');
  const net = document.getElementById('net');
  const btnPlay = document.getElementById('btnPlay');

  const offerOut = document.getElementById('offerOut');
  const answerIn = document.getElementById('answerIn');
  const offerIn = document.getElementById('offerIn');
  const answerOut = document.getElementById('answerOut');
  const btnCopyOffer = document.getElementById('btnCopyOffer');
  const btnShareOffer = document.getElementById('btnShareOffer');
  const btnMakeOffer = document.getElementById('btnMakeOffer');
  const btnApplyAnswer = document.getElementById('btnApplyAnswer');
  const btnMakeAnswer = document.getElementById('btnMakeAnswer');
  const btnCopyAnswer = document.getElementById('btnCopyAnswer');

  // --- State
  let matchType = 'ai'; // 'ai' | 'p2p'
  let role = null;      // 'host' | 'join'
  let mode = 'menu';    // 'menu' | 'online' | 'practice'
  let isHost = false;

  // --- Game constants (vertical)
  const PADDLE_W = 120, PADDLE_H = 12, BALL = 12;
  const player = {x:0, y:0, score:0};
  const enemy  = {x:0, y:0, score:0};
  const ball   = {x:0, y:0, vx:0, vy:0};

  function resetPositions(){
    player.x = W/2 - PADDLE_W/2; player.y = H - 28;
    enemy.x  = W/2 - PADDLE_W/2; enemy.y  = 16;
    ball.x = W/2; ball.y = H/2; ball.vx = (Math.random()>0.5?1:-1)*(3+Math.random()*2); ball.vy = (isHost?1:-1)*(3+Math.random()*2);
  }
  resetPositions();

  // --- Input
  let keys = {}; window.addEventListener('keydown', e=>keys[e.key]=true); window.addEventListener('keyup', e=>keys[e.key]=false);
  cvs.addEventListener('pointermove', e=>{
    if (mode!=='online' && mode!=='practice') return;
    const r=cvs.getBoundingClientRect(); const x=(e.clientX - r.left)*(W/r.width) - PADDLE_W/2;
    player.x = Math.max(0, Math.min(W-PADDLE_W, x));
  });
  function localStep(){
    if (mode!=='online' && mode!=='practice') return;
    if (keys['ArrowLeft']||keys['a']) player.x -= 7;
    if (keys['ArrowRight']||keys['d']) player.x += 7;
    player.x = Math.max(0, Math.min(W-PADDLE_W, player.x));
  }

  // --- Match type selection
  function updateTypeButtons(){
    btnTypeAI.className = (matchType==='ai')? 'primary' : 'secondary';
    btnTypeP2P.className = (matchType==='p2p')? 'primary' : 'secondary';
    roleBox.classList.toggle('hidden', matchType!=='p2p');
    signalBox.classList.toggle('hidden', matchType!=='p2p');
    btnPlay.disabled = (matchType==='p2p'); // для p2p кнопка активируется после online
  }
  btnTypeAI.onclick = ()=>{ matchType='ai'; role=null; updateTypeButtons(); };
  btnTypeP2P.onclick = ()=>{ matchType='p2p'; updateTypeButtons(); };
  updateTypeButtons();

  // --- Role selection
  btnHost.onclick = ()=>{ role='host'; btnHost.className='primary'; btnJoin.className='ghost'; hostPanel.classList.remove('hidden'); joinPanel.classList.add('hidden'); };
  btnJoin.onclick = ()=>{ role='join'; btnJoin.className='primary'; btnHost.className='ghost'; hostPanel.classList.add('hidden'); joinPanel.classList.remove('hidden'); };

  // --- Helpers
  const enc = obj => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
  const dec = str => JSON.parse(decodeURIComponent(escape(atob((str||'').trim()))));
  function copy(el){ el.select(); document.execCommand('copy'); }

  // --- WebRTC
  let pc, dc; let lastTick=0;
  function setupPeer(host){
    isHost = !!host;
    pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    pc.onicecandidate = e=>{ if(!e.candidate) updateSDP(); };
    pc.onconnectionstatechange = ()=>{ net.textContent = pc.connectionState || 'unknown'; if (pc.connectionState==='connected'){ btnPlay.disabled=false; }};
    pc.ondatachannel = ev=>{ dc = ev.channel; wireDC(); };
    if (host){ dc = pc.createDataChannel('game'); wireDC(); }
  }
  function wireDC(){
    dc.onopen = ()=>{ net.textContent='online'; };
    dc.onclose= ()=>{ net.textContent='disconnected'; btnPlay.disabled=true; };
    dc.onmessage = ev=>{
      const m = JSON.parse(ev.data);
      if (m.t==='state' && !isHost){
        const s = m.state;
        enemy.x = s.bottom.x; enemy.score = s.bottom.score; enemy.y = 16;
        player.x = s.top.x;   player.score = s.top.score;   player.y = H - 28;
        ball.x = s.ball.x; ball.y = s.ball.y;
      }
      if (m.t==='input' && isHost){ enemy.x = Math.max(0, Math.min(W-PADDLE_W, m.x)); }
    };
  }
  function updateSDP(){ if (!pc?.localDescription) return; const payload = enc({type:pc.localDescription.type, sdp:pc.localDescription.sdp}); if (isHost) offerOut.value = payload; else answerOut.value = payload; }
  async function makeOffer(){ if (!role||role!=='host') return; setupPeer(true); const offer = await pc.createOffer(); await pc.setLocalDescription(offer); updateSDP(); }
  async function applyAnswer(){ try{ const ans = dec(answerIn.value); await pc.setRemoteDescription(new RTCSessionDescription(ans)); }catch(e){ alert('Неверный answer'); } }
  async function acceptOffer(){ try{ setupPeer(false); const off = dec(offerIn.value); await pc.setRemoteDescription(new RTCSessionDescription(off)); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); updateSDP(); }catch(e){ alert('Неверный offer'); } }

  btnMakeOffer.onclick = makeOffer;
  btnApplyAnswer.onclick = applyAnswer;
  btnMakeAnswer.onclick = acceptOffer;
  btnCopyOffer.onclick = ()=>copy(offerOut);
  btnCopyAnswer.onclick = ()=>copy(answerOut);
  btnShareOffer.onclick = ()=>{
    const text = encodeURIComponent('Поиграем в Pong? Вставь мой offer и пришли answer.\n\n'+offerOut.value.substring(0,1800));
    if (tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/share/url?text='+text); else window.open('https://t.me/share/url?text='+text,'_blank');
  };

  // --- Physics (host authoritative)
  function physics(){
    // move ball
    ball.x += ball.vx; ball.y += ball.vy;
    // walls (X)
    if (ball.x<0 || ball.x>W-BALL) ball.vx *= -1;
    // top paddle (guest)
    if (ball.vy<0 && ball.y < enemy.y+PADDLE_H && ball.x+BALL>enemy.x && ball.x<enemy.x+PADDLE_W){ ball.vy = Math.abs(ball.vy); }
    // bottom paddle (host or player in AI)
    if (ball.vy>0 && ball.y+BALL > player.y && ball.x+BALL>player.x && ball.x<player.x+PADDLE_W){ ball.vy = -Math.abs(ball.vy); }
    // score
    if (ball.y < -BALL){ player.score++; resetBall(1); }
    if (ball.y > H+BALL){ enemy.score++; resetBall(-1); }
  }
  function resetBall(dir){ ball.x=W/2; ball.y=H/2; ball.vx=(Math.random()>0.5?1:-1)*(3+Math.random()*2); ball.vy=dir*(3+Math.random()*2); }

  // --- AI for practice
  function aiStep(){
    const target = ball.x - PADDLE_W/2; const speed = 5;
    enemy.x += Math.sign(target - enemy.x) * speed; enemy.x = Math.max(0, Math.min(W-PADDLE_W, enemy.x));
  }

  // --- Play button
  btnPlay.onclick = ()=>{
    if (matchType==='ai') { mode='practice'; isHost=true; menu.classList.add('hidden'); tg?.expand(); resetPositions(); return; }
    if (matchType==='p2p') {
      if (pc?.connectionState === 'connected' && dc?.readyState==='open') { mode='online'; menu.classList.add('hidden'); tg?.expand(); resetPositions(); } else { alert('Сначала установите соединение (online)'); }
    }
  };

  // --- Main loop
  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#fff';
    // paddles
    ctx.fillRect(player.x, player.y, PADDLE_W, PADDLE_H);
    ctx.fillRect(enemy.x, enemy.y, PADDLE_W, PADDLE_H);
    // ball
    ctx.fillRect(ball.x, ball.y, BALL, BALL);
    // score
    ctx.font='20px sans-serif';
    ctx.fillText(player.score, 16, H-20);
    ctx.fillText(enemy.score, 16, 36);
  }

  function loop(ts){
    localStep();
    if (mode==='practice'){
      aiStep(); physics();
    } else if (mode==='online'){
      if (dc && dc.readyState==='open'){
        dc.send(JSON.stringify({t:'input', x: player.x}));
      }
      if (isHost){
        physics();
        if (!lastTick || ts-lastTick>33){ lastTick=ts; if (dc && dc.readyState==='open'){
          const state = { bottom:{x:player.x, score:player.score}, top:{x:enemy.x, score:enemy.score}, ball:{x:ball.x, y:ball.y} };
          dc.send(JSON.stringify({t:'state', state}));
        }}
      }
    }
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  </script>
</body>
</html>
